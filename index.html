<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰π†ÊÉØÂÖªÊàêÊ†ë</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .header .actions {
            display: flex;
            gap: 10px;
        }
        
        .header button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .header button:hover {
            background: #f0f0f0;
        }
        
        .date-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .tree-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .habit-node {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .habit-node.level-1 { padding-left: 20px; }
        .habit-node.level-2 { padding-left: 40px; }
        .habit-node.level-3 { padding-left: 60px; }
        .habit-node.level-4 { padding-left: 80px; }
        .habit-node.level-5 { padding-left: 100px; }
        
        .habit-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .habit-name {
            font-size: 16px;
            color: #333;
            flex-grow: 1;
        }
        
        .streak {
            color: #52c41a;
            font-size: 14px;
            font-weight: bold;
            padding: 2px 8px;
            background: #f6ffed;
            border-radius: 12px;
        }
        
        .add-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-btn:hover {
            background: #40a9ff;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }
        
        .modal-content h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .modal-content input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 14px;
        }
        
        .modal-actions .confirm {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .modal-actions .confirm:hover {
            background: #40a9ff;
        }
        
        .modal-actions .cancel {
            background: white;
        }
        
        .modal-actions .cancel:hover {
            background: #f0f0f0;
        }
        
        .file-input {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .warning {
            background: #fff7e6;
            border: 1px solid #ffd591;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            color: #d46b08;
            display: none;
        }
        
        .warning.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå≥ ‰π†ÊÉØÂÖªÊàêÊ†ë</h1>
        <div class="date-info" id="dateInfo"></div>
        <div class="actions">
            <button onclick="exportData()">ÂØºÂá∫Êï∞ÊçÆ</button>
            <button onclick="importData()">ÂØºÂÖ•Êï∞ÊçÆ</button>
            <button onclick="resetToday()">ÈáçÁΩÆ‰ªäÊó•</button>
        </div>
    </div>
    
    <div class="warning" id="warning"></div>
    
    <div class="tree-container">
        <div id="treeContent"></div>
    </div>
    
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3>Ê∑ªÂä†Êñ∞‰π†ÊÉØ</h3>
            <input type="text" id="newHabitName" placeholder="ËØ∑ËæìÂÖ•‰π†ÊÉØÂêçÁß∞">
            <div class="modal-actions">
                <button class="cancel" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="confirm" onclick="confirmAddHabit()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
    
    <input type="file" class="file-input" id="fileInput" accept=".json">
    
    <script>
        // Êï∞ÊçÆÂ≠òÂÇ®ÈîÆÂêç
        const STORAGE_KEY = 'habitTreeData';
        
        // ÈªòËÆ§Êï∞ÊçÆÁªìÊûÑ
        const defaultData = {
            root: {
                id: 'root',
                name: 'ÊàëÁöÑ‰π†ÊÉØ',
                children: []
            },
            today: new Date().toISOString().split('T')[0],
            checked: []
        };
        
        // ÂÖ®Â±ÄÂèòÈáè
        let data = loadData();
        let addingParentId = null;
        
        // Âä†ËΩΩÊï∞ÊçÆ
        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•', e);
                    return defaultData;
                }
            }
            return defaultData;
        }
        
        // ‰øùÂ≠òÊï∞ÊçÆ
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        
        // Ëé∑Âèñ‰ªäÂ§©Êó•Êúü
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }
        
        // Ëé∑ÂèñÊò®Â§©Êó•Êúü
        function getYesterday() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }
        
        // ËÆ°ÁÆóÊó•ÊúüÂ∑Æ
        function daysDiff(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diff = Math.abs(d2 - d1);
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }
        
        // ÁîüÊàêÂîØ‰∏ÄID
        function generateId() {
            return 'h' + Date.now() + Math.random().toString(36).substr(2, 9);
        }
        
        // Ê£ÄÊü•ÊòØÂê¶‰∏∫Âè∂Â≠êËäÇÁÇπ
        function isLeaf(node) {
            return !node.children || node.children.length === 0;
        }
        
        // ÈÄíÂΩíÊü•ÊâæËäÇÁÇπ
        function findNode(node, id) {
            if (node.id === id) return node;
            if (node.children) {
                for (let child of node.children) {
                    const found = findNode(child, id);
                    if (found) return found;
                }
            }
            return null;
        }
        
        // ÈÄíÂΩíÂà†Èô§ËäÇÁÇπ
        function deleteNode(parent, nodeId) {
            if (!parent.children) return false;
            const index = parent.children.findIndex(child => child.id === nodeId);
            if (index !== -1) {
                parent.children.splice(index, 1);
                return true;
            }
            for (let child of parent.children) {
                if (deleteNode(child, nodeId)) return true;
            }
            return false;
        }
        
        // Ëé∑ÂèñÊâÄÊúâÂ≠êËäÇÁÇπID
        function getAllChildIds(node) {
            let ids = [node.id];
            if (node.children) {
                for (let child of node.children) {
                    ids = ids.concat(getAllChildIds(child));
                }
            }
            return ids;
        }
        
        // Ê£ÄÊü•Âπ∂Âà†Èô§Êú™ÂÆåÊàêÁöÑ‰π†ÊÉØ
        function checkAndDeleteUnfinished() {
            const today = getToday();
            const yesterday = getYesterday();
            
            // Â¶ÇÊûú‰∏çÊòØÊñ∞ÁöÑ‰∏ÄÂ§©Ôºå‰∏çÂ§ÑÁêÜ
            if (data.today === today) return [];
            
            let deletedHabits = [];
            
            // ÈÄíÂΩíÊ£ÄÊü•ÊØè‰∏™‰π†ÊÉØ
            function checkNode(node) {
                if (node.id === 'root') {
                    // Ê£ÄÊü•Ê†πËäÇÁÇπÁöÑÂ≠êËäÇÁÇπ
                    let i = node.children.length - 1;
                    while (i >= 0) {
                        if (!checkNode(node.children[i])) {
                            const deleted = node.children[i];
                            deletedHabits.push(deleted.name);
                            node.children.splice(i, 1);
                        }
                        i--;
                    }
                    return true;
                }
                
                // Ê£ÄÊü•‰π†ÊÉØÊòØÂê¶Êò®Â§©ÂÆåÊàê
                if (node.lastCheck !== yesterday) {
                    // ‰π†ÊÉØÊú™ÂÆåÊàêÔºåÈúÄË¶ÅÂà†Èô§
                    return false;
                }
                
                // Ê£ÄÊü•Â≠êËäÇÁÇπ
                if (node.children) {
                    let i = node.children.length - 1;
                    while (i >= 0) {
                        if (!checkNode(node.children[i])) {
                            const deleted = node.children[i];
                            deletedHabits.push(deleted.name);
                            node.children.splice(i, 1);
                        }
                        i--;
                    }
                }
                
                return true;
            }
            
            checkNode(data.root);
            
            // Êõ¥Êñ∞Êó•ÊúüÂíåÊ∏ÖÁ©∫‰ªäÊó•ÊâìÂç°
            data.today = today;
            data.checked = [];
            
            return deletedHabits;
        }
        
        // Ê∏≤Êüì‰π†ÊÉØÊ†ë
        function renderTree() {
            const container = document.getElementById('treeContent');
            
            if (!data.root.children || data.root.children.length === 0) {
                container.innerHTML = '<div class="empty-state">ËøòÊ≤°Êúâ‰π†ÊÉØÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏Ä‰∏™‰π†ÊÉØ<br><br><button class="add-btn" onclick="showAddModal(\'root\')">Ê∑ªÂä†‰π†ÊÉØ</button></div>';
                return;
            }
            
            let html = '';
            
            function renderNode(node, level = 0) {
                if (node.id === 'root') {
                    html += `<div class="habit-node level-0">
                        <span class="habit-name" style="font-weight: bold;">üìö ${node.name}</span>
                    </div>`;
                    if (node.children) {
                        for (let child of node.children) {
                            renderNode(child, level + 1);
                        }
                    }
                } else {
                    const isChecked = data.checked.includes(node.id);
                    const streakText = node.streak > 0 ? `${node.streak}Â§©` : 'Êñ∞‰π†ÊÉØ';
                    
                    html += `<div class="habit-node level-${level}">
                        <input type="checkbox" class="habit-checkbox" 
                               id="check-${node.id}" 
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleHabit('${node.id}')">
                        <label for="check-${node.id}" class="habit-name">${node.name}</label>
                        <span class="streak">${streakText}</span>
                        ${isLeaf(node) ? `<button class="add-btn" onclick="showAddModal('${node.id}')">+</button>` : ''}
                    </div>`;
                    
                    if (node.children) {
                        for (let child of node.children) {
                            renderNode(child, level + 1);
                        }
                    }
                }
            }
            
            renderNode(data.root);
            
            // Â¶ÇÊûúÊ†πËäÇÁÇπÊ≤°ÊúâÂ≠êËäÇÁÇπÊàñÊâÄÊúâÂ≠êËäÇÁÇπÈÉΩÊòØÂè∂Â≠êÔºå‰πüÂú®Ê†πËäÇÁÇπÊòæÁ§∫Ê∑ªÂä†ÊåâÈíÆ
            const allLeaves = !data.root.children || data.root.children.every(child => isLeaf(child));
            if (allLeaves) {
                html += `<div class="habit-node level-1">
                    <button class="add-btn" onclick="showAddModal('root')">Ê∑ªÂä†Êñ∞‰π†ÊÉØ</button>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        // ÂàáÊç¢‰π†ÊÉØÁä∂ÊÄÅ
        function toggleHabit(habitId) {
            const checkbox = document.getElementById(`check-${habitId}`);
            const node = findNode(data.root, habitId);
            
            if (!node) return;
            
            const today = getToday();
            
            if (checkbox.checked) {
                // ÊâìÂç°
                if (!data.checked.includes(habitId)) {
                    data.checked.push(habitId);
                }
                
                // Êõ¥Êñ∞ËøûÁª≠Â§©Êï∞
                if (node.lastCheck) {
                    const diff = daysDiff(node.lastCheck, today);
                    if (diff === 1) {
                        // ËøûÁª≠ÊâìÂç°
                        node.streak = (node.streak || 0) + 1;
                    } else if (diff === 0) {
                        // ‰ªäÂ§©Â∑≤ÊâìÂç°Ôºå‰∏çÂ¢ûÂä†
                    } else {
                        // ‰∏≠Êñ≠‰∫ÜÔºåÈáçÊñ∞ÂºÄÂßã
                        node.streak = 1;
                    }
                } else {
                    // Á¨¨‰∏ÄÊ¨°ÊâìÂç°
                    node.streak = 1;
                }
                
                node.lastCheck = today;
                
                // Ëá™Âä®ÂãæÈÄâÊâÄÊúâÁà∂ËäÇÁÇπ
                checkParents(habitId);
            } else {
                // ÂèñÊ∂àÊâìÂç°
                const index = data.checked.indexOf(habitId);
                if (index > -1) {
                    data.checked.splice(index, 1);
                }
                
                // Â¶ÇÊûú‰ªäÂ§©ÂàöÊâìÁöÑÂç°ÔºåÂáèÂ∞ëËøûÁª≠Â§©Êï∞
                if (node.lastCheck === today && node.streak > 0) {
                    node.streak--;
                    if (node.streak === 0) {
                        node.lastCheck = null;
                    } else {
                        // ÊÅ¢Â§çÂà∞Êò®Â§©ÁöÑÊó•Êúü
                        const date = new Date();
                        date.setDate(date.getDate() - 1);
                        node.lastCheck = date.toISOString().split('T')[0];
                    }
                }
                
                // Ëá™Âä®ÂèñÊ∂àÊâÄÊúâÂ≠êËäÇÁÇπ
                uncheckChildren(habitId);
            }
            
            saveData();
            renderTree();
        }
        
        // Ëá™Âä®ÂãæÈÄâÁà∂ËäÇÁÇπ
        function checkParents(nodeId) {
            function findParent(parent, targetId) {
                if (parent.children) {
                    for (let child of parent.children) {
                        if (child.id === targetId) {
                            return parent;
                        }
                        const found = findParent(child, targetId);
                        if (found) return found;
                    }
                }
                return null;
            }
            
            const parent = findParent(data.root, nodeId);
            if (parent && parent.id !== 'root') {
                if (!data.checked.includes(parent.id)) {
                    data.checked.push(parent.id);
                    
                    // Êõ¥Êñ∞Áà∂ËäÇÁÇπÁöÑstreak
                    const today = getToday();
                    const node = findNode(data.root, parent.id);
                    if (node) {
                        if (node.lastCheck) {
                            const diff = daysDiff(node.lastCheck, today);
                            if (diff === 1) {
                                node.streak = (node.streak || 0) + 1;
                            } else if (diff === 0) {
                                // ‰ªäÂ§©Â∑≤ÊâìÂç°
                            } else {
                                node.streak = 1;
                            }
                        } else {
                            node.streak = 1;
                        }
                        node.lastCheck = today;
                    }
                }
                checkParents(parent.id);
            }
        }
        
        // Ëá™Âä®ÂèñÊ∂àÂ≠êËäÇÁÇπ
        function uncheckChildren(nodeId) {
            const node = findNode(data.root, nodeId);
            if (!node || !node.children) return;
            
            for (let child of node.children) {
                const index = data.checked.indexOf(child.id);
                if (index > -1) {
                    data.checked.splice(index, 1);
                }
                
                // Êõ¥Êñ∞Â≠êËäÇÁÇπÁöÑstreak
                const today = getToday();
                if (child.lastCheck === today && child.streak > 0) {
                    child.streak--;
                    if (child.streak === 0) {
                        child.lastCheck = null;
                    } else {
                        const date = new Date();
                        date.setDate(date.getDate() - 1);
                        child.lastCheck = date.toISOString().split('T')[0];
                    }
                }
                
                uncheckChildren(child.id);
            }
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†‰π†ÊÉØÂºπÁ™ó
        function showAddModal(parentId) {
            addingParentId = parentId;
            document.getElementById('addModal').classList.add('show');
            document.getElementById('newHabitName').value = '';
            document.getElementById('newHabitName').focus();
        }
        
        // ÂÖ≥Èó≠ÂºπÁ™ó
        function closeModal() {
            document.getElementById('addModal').classList.remove('show');
            addingParentId = null;
        }
        
        // Á°ÆËÆ§Ê∑ªÂä†‰π†ÊÉØ
        function confirmAddHabit() {
            const name = document.getElementById('newHabitName').value.trim();
            if (!name) {
                alert('ËØ∑ËæìÂÖ•‰π†ÊÉØÂêçÁß∞');
                return;
            }
            
            const parent = findNode(data.root, addingParentId);
            if (!parent) {
                alert('Ê∑ªÂä†Â§±Ë¥•ÔºöÊâæ‰∏çÂà∞Áà∂ËäÇÁÇπ');
                return;
            }
            
            if (!parent.children) {
                parent.children = [];
            }
            
            const newHabit = {
                id: generateId(),
                name: name,
                streak: 0,
                lastCheck: null,
                children: []
            };
            
            parent.children.push(newHabit);
            
            saveData();
            renderTree();
            closeModal();
        }
        
        // ÂØºÂá∫Êï∞ÊçÆ
        function exportData() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tree-${getToday()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ÂØºÂÖ•Êï∞ÊçÆ
        function importData() {
            const input = document.getElementById('fileInput');
            input.click();
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.root) {
                            if (confirm('ÂØºÂÖ•Êï∞ÊçÆÂ∞ÜË¶ÜÁõñÁé∞ÊúâÊï∞ÊçÆÔºåÊòØÂê¶ÁªßÁª≠Ôºü')) {
                                data = imported;
                                saveData();
                                renderTree();
                                updateDateInfo();
                                alert('ÂØºÂÖ•ÊàêÂäü');
                            }
                        } else {
                            alert('Êó†ÊïàÁöÑÊï∞ÊçÆÊ†ºÂºè');
                        }
                    } catch (e) {
                        alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + e.message);
                    }
                };
                reader.readAsText(file);
                input.value = '';
            };
        }
        
        // ÈáçÁΩÆ‰ªäÊó•
        function resetToday() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‰ªäÊó•ÁöÑÊâÄÊúâÊâìÂç°ËÆ∞ÂΩïÂêóÔºü')) {
                data.checked = [];
                // ÈáçÁΩÆÊâÄÊúâ‰π†ÊÉØÁöÑ‰ªäÊó•ÊâìÂç°Áä∂ÊÄÅ
                function resetNode(node) {
                    if (node.id !== 'root' && node.lastCheck === getToday()) {
                        if (node.streak > 0) {
                            node.streak--;
                        }
                        if (node.streak === 0) {
                            node.lastCheck = null;
                        } else {
                            const date = new Date();
                            date.setDate(date.getDate() - 1);
                            node.lastCheck = date.toISOString().split('T')[0];
                        }
                    }
                    if (node.children) {
                        for (let child of node.children) {
                            resetNode(child);
                        }
                    }
                }
                resetNode(data.root);
                saveData();
                renderTree();
            }
        }
        
        // Êõ¥Êñ∞Êó•Êúü‰ø°ÊÅØ
        function updateDateInfo() {
            const today = getToday();
            const dateStr = new Date().toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            document.getElementById('dateInfo').textContent = `‰ªäÂ§©Ôºö${dateStr}`;
        }
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            // ESCÂÖ≥Èó≠ÂºπÁ™ó
            if (e.key === 'Escape') {
                closeModal();
            }
            // Âú®ÂºπÁ™ó‰∏≠ÊåâEnterÁ°ÆËÆ§
            if (e.key === 'Enter' && document.getElementById('addModal').classList.contains('show')) {
                confirmAddHabit();
            }
        });
        
        // ÂàùÂßãÂåñ
        function init() {
            updateDateInfo();
            
            // Ê£ÄÊü•Âπ∂Âà†Èô§Êú™ÂÆåÊàêÁöÑ‰π†ÊÉØ
            const deleted = checkAndDeleteUnfinished();
            if (deleted.length > 0) {
                const warning = document.getElementById('warning');
                warning.textContent = `‚ö†Ô∏è Áî±‰∫éÊò®Êó•Êú™ÂÆåÊàêÔºå‰ª•‰∏ã‰π†ÊÉØÂàÜÊîØÂ∑≤Ë¢´Âà†Èô§Ôºö${deleted.join('„ÄÅ')}`;
                warning.classList.add('show');
                setTimeout(() => {
                    warning.classList.remove('show');
                }, 5000);
            }
            
            saveData();
            renderTree();
            
            // ÊØèÂàÜÈíüÊ£ÄÊü•Êó•ÊúüÂèòÂåñ
            setInterval(() => {
                const currentDate = getToday();
                if (data.today !== currentDate) {
                    location.reload();
                }
            }, 60000);
        }
        
        // ÂêØÂä®Â∫îÁî®
        init();
    </script>
</body>
</html>